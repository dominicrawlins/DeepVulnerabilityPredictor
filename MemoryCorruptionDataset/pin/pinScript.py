import os, subprocess


def getpin(dir, ddir, pinhome):
    otherfiles = list(map(lambda x: x.replace("file_", ""), list(filter(lambda x : "file" in x, (os.listdir(os.path.join(os.path.expanduser(dir), ddir, 'dynamic/inputs' )))))))
    argfiles = list(filter(lambda x: "symb" in x, (os.listdir(os.path.join(os.path.expanduser(dir), ddir, 'dynamic/inputs' )))))
    args = []
    for argfile in sorted(argfiles):
        with open((os.path.join(os.path.expanduser(dir), ddir, 'dynamic/inputs', argfile))) as file:
            arg = str(next(file)).strip()
            if(arg in otherfiles):
                arg = os.readlink(os.path.join(os.path.expanduser(dir), ddir, 'dynamic/inputs','file_'+ arg))
            args.append(arg)

    outfolder = os.path.join(os.path.expanduser('~/DeepVulnerabilityPredictor/data/pin'), ddir)
    if(not os.path.exists(outfolder)):
        os.mkdir(outfolder)
    with open(os.path.join(os.path.expanduser(dir), ddir, 'details.txt')) as detailsfile:
        location = (list(map(lambda x: x.split(":")[1].strip(), list(filter(lambda x: "location" in x, list(detailsfile))))))[0]
        subprocess.run([pinhome + '/pin', '-t', pinhome+'/source/tools/MyPinTool/obj-intel64/myPinTool.so',
                        '-o', outfolder+'/out', '--', location] + args)



def apply_pin(dir, pinhome):
    for ddir in os.listdir(os.path.expanduser(dir)):
        if(os.path.exists(os.path.join(os.path.expanduser(dir), ddir, 'dynamic'))):
            print(ddir)
            getpin(dir, ddir, pinhome)


def vm_pin(dir, pinhome):
    for ddir in list(filter(lambda x: "tar." not in x, os.listdir(os.path.expanduser(dir)))):
        # for arg in list(filter(lambda x: "file" in x, (os.listdir(os.path.expanduser(os.path.join(dir, ddir, 'crash')))))):
            # with open(os.path.expanduser(os.path.join(dir, ddir, 'crash', arg)), encoding="ISO-8859-1") as afile:
            #     data = afile.readlines()
            # filename = arg.split("_")[1].split(".")[0].strip()
            # if(filename):
            #     with open(os.path.expanduser(os.path.join(dir, ddir, 'crash', filename)), 'w', encoding="ISO-8859-1") as nfile:
            #         nfile.write(str(data))
        arglist = [0] * 4
        for arg in list(filter(lambda x: "arg" in x, (os.listdir(os.path.expanduser(os.path.join(dir, ddir, 'crash')))))):
            data = str(open(os.path.expanduser(os.path.join(dir, ddir, 'crash', arg)), encoding="ISO-8859-1").read()).replace("\x00", "")
            index = int(arg.split("_")[1].split(".")[0]) - 1
            arglist[index] = data
        with open(os.path.expanduser(os.path.join(dir, ddir, 'path.txt'))) as lfile:
            location = next(lfile).strip()
        print(ddir, location, arglist)

        outfolder = os.path.join(os.path.expanduser('~/sync/data'), ddir)
        if(not os.path.exists(outfolder)):
            os.mkdir(outfolder)

        os.chdir(os.path.expanduser(os.path.join(dir, ddir, 'crash')))

        subprocess.run([pinhome + '/pin', '-t', pinhome+'/source/tools/MyPinTool/obj-ia32/myPinTool.so',
                '-o', outfolder+'/out', '--', location] + arglist)



pinhome = '/home/vagrant/pin/pin-3.13-98189-g60a6ef199-gcc-linux'
dir = '~/sync/'
vm_pin(dir, pinhome)
